services:
  # ----------------------------------------
  # Anvil (Foundry local blockchain)
  # ----------------------------------------
  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    user: "0"
    environment:
      ANVIL_IP_ADDR: 0.0.0.0
    command: >
      anvil
      --port 8545
      --chain-id 31337
      --base-fee 0
      --gas-price 0
      --gas-limit 30000000
    ports:
      - "8545:8545"
    volumes:
      - .:/app
    working_dir: /app
  
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 2s
      retries: 10

  solana:
    image: solanalabs/solana:v1.18.3
    command: ["solana-test-validator", "--quiet"]
    ports:
      - "8899:8899"

  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    env_file:
      - .env.deployed # <-- ADD THIS
    environment:
      # Keep non-contract specific vars here
      GRAO_BASE_URL: ${GRAO_BASE_URL}
      GRAO_CLIENT_ID: ${GRAO_CLIENT_ID}
      GRAO_CLIENT_SECRET: ${GRAO_CLIENT_SECRET}
      JWT_SECRET: ${JWT_SECRET}
      GRAO_REDIRECT_URI: ${GRAO_REDIRECT_URI}
      USE_REAL_OAUTH: ${USE_REAL_OAUTH}
      EVM_RPC: http://anvil:8545
      CELERY_BROKER: redis://redis:6379/0
      CELERY_BACKEND: redis://redis:6379/0
      DATABASE_URL: postgres://postgres:pass@db:5432/postgres
    ports:
      - "8000:8000"
    depends_on:
      - redis
      - db

  worker:
    build:
      context: .
      dockerfile: Dockerfile.backend
    command: celery -A packages.backend.proof.celery_app worker --loglevel=info
    environment:
      CELERY_BROKER: redis://redis:6379/0
      CELERY_BACKEND: redis://redis:6379/0
      DATABASE_URL: postgres://postgres:${POSTGRES_PASSWORD}@db:5432/postgres
    depends_on:
      - redis
      - db

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    env_file:
      - .env.deployed # <-- ADD THIS
    environment:
      # Keep non-contract specific vars here
      NEXT_PUBLIC_API_BASE: http://backend:8000
      NEXT_PUBLIC_BUNDLER_URL: ${NEXT_PUBLIC_BUNDLER_URL:-http://localhost:3001}
    ports:
      - "3000:3000"
    depends_on:
      - backend

  orchestrator:
    build:
      context: services/orchestrator
      dockerfile: Dockerfile
    env_file:
      - .env.deployed # <-- ADD THIS
    environment:
      EVM_RPC: http://anvil:8545
      EVM_MAX_RETRIES: "0"
      # ELECTION_MANAGER is now in the env_file
      ORCHESTRATOR_KEY: ${ORCHESTRATOR_KEY}
    volumes:
      - ./circuits:/app/circuits
    depends_on:
      - anvil

  relay:
    build:
      context: .
      dockerfile: services/relay-daemon/Dockerfile
    restart: always
    env_file:
      - .env.deployed # <-- ADD THIS
    environment:
      EVM_RPC: http://anvil:8545
      SOLANA_RPC: http://solana:8899
      POSTGRES_URL: postgres://postgres:${POSTGRES_PASSWORD}@db:5432/postgres
      # ELECTION_MANAGER is now in the env_file
      SOLANA_BRIDGE_SK: ${SOLANA_BRIDGE_SK}
    ports:
      - "9300:9300"
    depends_on:
      db:
        condition: service_healthy
      anvil:
        condition: service_started
      solana:
        condition: service_started
